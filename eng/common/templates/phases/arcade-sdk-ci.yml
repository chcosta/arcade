# build.yml
# Description: Defines the build phase
# Parameters:
#   agentOs: [Windows_NT (default), Linux, OSX] Used in templates to define variables which are OS specific
#   dockerImage: If defined, specifies docker image to run build steps in
#   matrix: build matrix
#   queueName: agent pool name
#   enableTelemetry: send telemetry if build is not a PR or CI build

parameters:
  dockerImage: ''
  queue: {}

phases:
- phase: ${{ parameters.agentOs }}
  queue: ${{ parameters.phase.queue }}
  ${{ if and(ne(parameters.phase.variables, ''), eq(parameters.dockerImage, '')) }}:
    variables: ${{ parameters.phase.variables }}
  ${{ if ne(parameters.dockerImage, '') }}:
    variables:
      _PREVIEW_VSTS_DOCKER_IMAGE: ${{ parameters.dockerImage }}
      ${{ insert }}: ${{ parameters.phase.variables }}
  steps:
  - checkout: self
    clean: ${{ parameters.clean }}
    ${{ if ne(parameters.fetchDepth, '') }}:
      fetchDepth: ${{ parameters.fetchDepth }}
  - ${{ parameters.phase.steps }}
  - ${{ if eq(parameters.agentOs, 'Windows_NT') }}:
    - script: eng\common\cibuild.cmd $(_BuildArgs)
      name: Build
      condition: succeeded()
  - ${{ if ne(parameters.agentOs, 'Windows_NT') }}:
    - script: eng/common/cibuild.sh $(_BuildArgs)
      name: Build
      condition: succeeded()
