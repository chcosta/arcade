parameters:
  buildReason: IndividualCI
  steps: []

steps:
- ${{ if notIn(parameters.buildReason, 'IndividualCI', 'BatchedCI', 'PullRequest') }}:
  - task: ms-vseng.MicroBuildTasks.30666190-6959-11e5-9f96-f56098202fef.MicroBuildSigningPlugin@1
    displayName: Install MicroBuild plugin
    inputs:
      signType: $(_SignType )
      zipSources: false
      esrpSigning: $(_UseEsrpSigning)
    env:
      TeamName: $(_TeamName)
    continueOnError: false
    condition: and(succeeded(), in(variables._SignType, 'real', 'test'))
  - task: AzureKeyVault@1
    inputs:
      azureSubscription: 'DotNet-Engineering-Services_KeyVault'
      KeyVaultName: EngKeyVault
      SecretsFilter: 'dotnetfeed-storage-access-key-1'
    condition: succeeded()

- ${{ parameters.steps }}

- ${{ if notIn(parameters.buildReason, 'IndividualCI', 'BatchedCI', 'PullRequest') }}:
  - task: CopyFiles@2
    displayName: Gather Logs
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/artifacts'
      Contents: '**/*log'
      TargetFolder: '$(Build.StagingDirectory)/BuildLogs'
    continueOnError: true
    condition: succeededOrFailed()
  - task: PublishBuildArtifacts@1
    displayName: Publish Logs to VSTS
    inputs:
      PathtoPublish: '$(Build.StagingDirectory)/BuildLogs'
      ArtifactName: $(_agentOs)_$(Agent.JobName)
      PublishLocation: Container
    continueOnError: true
    condition: succeededOrFailed()
